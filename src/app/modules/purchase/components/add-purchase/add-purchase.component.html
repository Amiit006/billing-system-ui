<!-- src/app/modules/purchase/components/add-purchase/add-purchase.component.html -->
<!-- COMPLETE VERSION - Following the proven billing component pattern -->

<div class="mt-2 text-center">
    <h3>{{selectedSeason?.seasonName}}</h3>
    <p>
        {{selectedSeason?.startDate | date : 'dd-MMM-yyyy'}} to {{selectedSeason?.endDate | date : 'dd-MMM-yyyy'}}
    </p>
</div>

<div class="container">
    <form [formGroup]="purchaseForm">
        
        <!-- Basic Purchase Information -->
        <mat-card>
            <mat-card-title>Purchase Details</mat-card-title>
            <mat-divider></mat-divider>
            
            <div class="row mt-4">
                <div class="col-6">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Party Name</mat-label>
                        <input matInput placeholder="Party Name" type="text" formControlName="partyName">
                        <mat-error *ngIf="purchaseForm.get('partyName')?.hasError('required')">
                            Party name is required
                        </mat-error>
                    </mat-form-field>
                </div>
                <div class="col-6">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Purchase Date</mat-label>
                        <input [max]="maxDate" [min]="minDate" matInput [matDatepicker]="picker" formControlName="purchaseDate">
                        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
                        <mat-datepicker #picker></mat-datepicker>
                    </mat-form-field>
                </div>
            </div>
        </mat-card>

        <!-- Product Breakdown Section -->
        <mat-card class="mt-3">
            <mat-card-title>
                Product Breakdown
                <span class="badge badge-primary ml-2">Total: ₹{{totalPurchaseAmount | number:'1.2-2'}}</span>
            </mat-card-title>
            <mat-divider></mat-divider>

            <!-- Products Table -->
            <div class="table-responsive mt-3" formArrayName="items">
                <table class="table table-bordered">
                    <thead class="thead-light">
                        <tr>
                            <th style="width: 50px;">Sl No</th>
                            <th style="width: 250px;">Product Name *</th>
                            <th style="width: 100px;">Quantity *</th>
                            <th style="width: 100px;">Rate/Unit *</th>
                            <th style="width: 120px;">Total Amount</th>
                            <th style="width: 100px;">% Share</th>
                            <th style="width: 120px;">Final Cost/Unit</th>
                            <th style="width: 80px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let item of items.controls; let i = index" [formGroupName]="i" class="product-row">
                            
                            <!-- Serial Number -->
                            <td class="text-center">
                                <input type="text" class="form-control text-center" formControlName="slNo" readonly>
                            </td>

                            <!-- Product Name with Typeahead -->
                            <td>
                                <div class="position-relative">
                                    <input 
                                        type="text" 
                                        #inputToFocus 
                                        class="form-control" 
                                        placeholder="Type product name..." 
                                        formControlName="productName"
                                        [ngbTypeahead]="searchProducts"
                                        (selectItem)="onProductSelected($event, i)"
                                        [class.is-invalid]="item.get('productName')?.invalid && item.get('productName')?.touched">
                                    
                                    <!-- New Product Indicator -->
                                    <span *ngIf="isNewProduct(i)" class="badge badge-success position-absolute" 
                                          style="top: -8px; right: -8px; font-size: 10px;">NEW</span>
                                    
                                    <!-- Add Product Button -->
                                    <button type="button" 
                                            class="btn btn-sm btn-outline-primary position-absolute" 
                                            style="top: 2px; right: 2px; padding: 2px 6px;"
                                            (click)="openAddProductDialog(i)">
                                        <i class="fa fa-plus"></i>
                                    </button>
                                    
                                    <div *ngIf="item.get('productName')?.invalid && item.get('productName')?.touched" 
                                         class="invalid-feedback">
                                        Product name is required
                                    </div>
                                </div>
                            </td>

                            <!-- Quantity -->
                            <td>
                                <input 
                                    type="number" 
                                    class="form-control text-center" 
                                    placeholder="0"
                                    formControlName="quantity"
                                    (input)="onQuantityChange(i)"
                                    min="1"
                                    [class.is-invalid]="item.get('quantity')?.invalid && item.get('quantity')?.touched">
                                <div *ngIf="item.get('quantity')?.invalid && item.get('quantity')?.touched" 
                                     class="invalid-feedback">
                                    Quantity required (min: 1)
                                </div>
                            </td>

                            <!-- Rate Per Unit -->
                            <td>
                                <div class="input-group">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text">₹</span>
                                    </div>
                                    <input 
                                        type="number" 
                                        class="form-control text-right" 
                                        placeholder="0.00"
                                        formControlName="ratePerUnit"
                                        (input)="onRateChange(i)"
                                        min="0"
                                        step="0.01"
                                        [class.is-invalid]="item.get('ratePerUnit')?.invalid && item.get('ratePerUnit')?.touched">
                                </div>
                                <div *ngIf="item.get('ratePerUnit')?.invalid && item.get('ratePerUnit')?.touched" 
                                     class="invalid-feedback">
                                    Rate required (min: 0)
                                </div>
                            </td>

                            <!-- Total Amount -->
                            <td>
                                <div class="calculated-field">
                                    ₹{{item.get('total')?.value | number:'1.2-2'}}
                                </div>
                            </td>

                            <!-- Percentage Share -->
                            <td>
                                <div class="calculated-field">
                                    {{item.get('percentageOfPurchase')?.value | number:'1.2-2'}}%
                                </div>
                            </td>

                            <!-- Final Cost Per Unit -->
                            <td>
                                <div class="calculated-field final-cost">
                                    ₹{{item.get('finalCostPerUnit')?.value | number:'1.2-2'}}
                                </div>
                            </td>

                            <!-- Actions -->
                            <td class="text-center">
                                <button type="button" 
                                        class="btn btn-sm btn-outline-danger"
                                        (click)="removeRow(i)"
                                        [disabled]="items.length <= 1">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Add Product Button -->
            <div class="text-right mt-2 mb-3">
                <button type="button" class="btn btn-primary" (click)="addRow()">
                    <i class="fa fa-plus"></i> Add Product
                </button>
            </div>
        </mat-card>

        <!-- Cost Allocation Preview -->
        <mat-card class="mt-3">
            <mat-card-title>Cost Allocation Summary</mat-card-title>
            <mat-divider></mat-divider>
            
            <div class="row mt-3">
                <div class="col-md-6">
                    <div class="card bg-light">
                        <div class="card-body">
                            <h6 class="card-title">Purchase Breakdown</h6>
                            <div class="d-flex justify-content-between">
                                <span>Total Product Cost:</span>
                                <strong>₹{{totalPurchaseAmount | number:'1.2-2'}}</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Tax Amount:</span>
                                <span>₹{{purchaseForm.get('taxAmount')?.value | number:'1.2-2'}}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Packing Charges:</span>
                                <span>₹{{purchaseForm.get('packingCharge')?.value | number:'1.2-2'}}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Transport Charges:</span>
                                <span>₹{{purchaseForm.get('transport.amount')?.value | number:'1.2-2'}}</span>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <strong>Grand Total:</strong>
                                <strong class="text-success">₹{{grandTotal | number:'1.2-2'}}</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </mat-card>

        <!-- Overhead Costs -->
        <mat-card class="mt-3">
            <mat-card-title>Overhead Costs</mat-card-title>
            <mat-divider></mat-divider>
            
            <div class="row mt-4">
                <div class="col-4">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Packing Charges</mat-label>
                        <span matPrefix>₹</span>
                        <input matInput placeholder="0.00" type="number" min="0" step="0.01" formControlName="packingCharge">
                    </mat-form-field>
                </div>
                <div class="col-4">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Tax Amount</mat-label>
                        <span matPrefix>₹</span>
                        <input matInput placeholder="0.00" type="number" min="0" step="0.01" formControlName="taxAmount">
                    </mat-form-field>
                </div>
                <div class="col-4">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Tax Percent</mat-label>
                        <input disabled matInput placeholder="0.00" type="number" formControlName="taxPercent">
                        <span matSuffix>%</span>
                    </mat-form-field>
                </div>
            </div>

            <div class="row">
                <div class="col-4">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Discount Amount</mat-label>
                        <span matPrefix>₹</span>
                        <input matInput placeholder="0.00" type="number" min="0" step="0.01" formControlName="discountAmount">
                    </mat-form-field>
                </div>
                <div class="col-4">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Discount Percent</mat-label>
                        <input disabled matInput placeholder="0.00" type="number" formControlName="discountPercent">
                        <span matSuffix>%</span>
                    </mat-form-field>
                </div>
                <div class="col-4">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Extra Discount Amount</mat-label>
                        <span matPrefix>₹</span>
                        <input matInput placeholder="0.00" type="number" min="0" step="0.01" formControlName="extraDiscountAmount">
                    </mat-form-field>
                </div>
            </div>
        </mat-card>

        <!-- Transport Details -->
        <mat-card class="mt-3" formGroupName="transport">
            <mat-card-title>Transport Details</mat-card-title>
            <mat-divider></mat-divider>
            
            <div class="row mt-4">
                <div class="col-4">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Transport Name</mat-label>
                        <input matInput placeholder="Transport Name" type="text" formControlName="transportName">
                    </mat-form-field>
                </div>
                <div class="col-4">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Transport Amount</mat-label>
                        <span matPrefix>₹</span>
                        <input matInput placeholder="0.00" type="number" min="0" step="0.01" formControlName="amount">
                    </mat-form-field>
                </div>
                <div class="col-4">
                    <mat-form-field appearance="outline" class="w-100">
                        <mat-label>Consignment No</mat-label>
                        <input matInput placeholder="Consignment No" type="text" formControlName="consignmentNumber">
                    </mat-form-field>
                </div>
            </div>
        </mat-card>

        <!-- Payment Details -->
        <mat-card class="mt-3" formArrayName="payments">
            <mat-card-title>Payment Details</mat-card-title>
            <mat-divider></mat-divider>
            
            <div *ngFor="let payment of payments.controls; let i=index" [formGroupName]="i" class="payment-row">
                <div class="row mt-4">
                    <div class="col-3">
                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Payment Date</mat-label>
                            <input [max]="maxDate" matInput [matDatepicker]="picker1" formControlName="paymentDate">
                            <mat-datepicker-toggle matSuffix [for]="picker1"></mat-datepicker-toggle>
                            <mat-datepicker #picker1></mat-datepicker>
                        </mat-form-field>
                    </div>
                    <div class="col-3">
                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Amount</mat-label>
                            <span matPrefix>₹</span>
                            <input matInput placeholder="0.00" min="0" step="0.01" type="number" formControlName="amount">
                        </mat-form-field>
                    </div>
                    <div class="col-3">
                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Payment Mode</mat-label>
                            <mat-select formControlName="mode" (selectionChange)="onPaymentModeChange($event.value, i)">
                                <mat-option *ngFor="let paymentMode of paymentModes" [value]="paymentMode.value">
                                    {{ paymentMode.viewValue }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                    <div class="col-3">
                        <button type="button" class="btn btn-outline-danger mt-2" (click)="removePayment(i)">
                            <i class="fa fa-trash"></i> Remove
                        </button>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col-4">
                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Cheque No</mat-label>
                            <input matInput placeholder="0000000" min="0" type="number" formControlName="chequeNo">
                        </mat-form-field>
                    </div>
                    <div class="col-8">
                        <mat-form-field appearance="outline" class="w-100">
                            <mat-label>Remarks</mat-label>
                            <textarea matInput rows="2" formControlName="remark"></textarea>
                        </mat-form-field>
                    </div>
                </div>
            </div>
            
            <!-- Add Payment Button -->
            <div class="text-right mt-2 mb-3">
                <button type="button" class="btn btn-outline-primary" (click)="addPayment()">
                    <i class="fa fa-plus"></i> Add Payment
                </button>
            </div>
        </mat-card>

        <!-- Action Buttons -->
        <div class="text-center mt-4 mb-4">
            <button type="button" 
                    class="btn btn-success btn-lg mr-3" 
                    [disabled]="purchaseForm.invalid" 
                    (click)="onSave()">
                <i class="fa fa-save"></i> Save Purchase
            </button>
            <button type="button" 
                    class="btn btn-secondary btn-lg" 
                    (click)="onCancel()">
                <i class="fa fa-times"></i> Cancel
            </button>
        </div>
    </form>
</div>